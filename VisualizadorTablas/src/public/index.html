<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gr치ficas de Latencia y Uso de CPU/Memoria</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Gr치ficas de Latencia y Uso de CPU/Memoria</h1>
    <canvas id="latenciaChart" width="400" height="200"></canvas>
    <canvas id="cpuChart"></canvas>
    <canvas id="memoryChart"></canvas>

    <script>
        async function fetchLatencia() {
            const response = await fetch('/latencia');
            return await response.json();
        }

        async function fetchCpuMemory() {
            const response = await fetch('/cpu-memory');
            return await response.json();
        }

        function drawLatenciaChart(data) {
            const ctx = document.getElementById('latenciaChart').getContext('2d');
            
            const labels = [];
            const latencias = [];

            data.forEach(item => {
                const key = Object.keys(item)[0];
                labels.push(key);

                const latenciaArray = item[key];
                const latencia2000 = latenciaArray.find(lat => lat[2000]);
                latencias.push(latencia2000 ? latencia2000[2000] : 0);
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Latencia Promedio para 2000 bytes',
                        data: latencias,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function drawCpuMemoryChart(cpuData, memoryData) {
            const ctxCpu = document.getElementById('cpuChart').getContext('2d');
            const ctxMemory = document.getElementById('memoryChart').getContext('2d');

            // Extraer los datos de CPU
            const cpuTimestamps = cpuData.map(entry => new Date(entry.timestamp).toLocaleTimeString());
            const cpuValues = cpuData.map(entry => entry.cpu[0]);

            // Extraer los datos de memoria (rss)
            const memoryTimestamps = memoryData.map(entry => new Date(entry.timestamp).toLocaleTimeString());
            const memoryValues = memoryData.map(entry => entry.memory);
            console.log("memoryValues: ", memoryValues);
            console.log("memoryTimestamps: ", memoryTimestamps);
            // Gr치fica de CPU
            new Chart(ctxCpu, {
                type: 'line',
                data: {
                    labels: cpuTimestamps,
                    datasets: [{
                        label: 'Uso de CPU',
                        data: cpuValues,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        fill: false,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Gr치fica de Memoria
            new Chart(ctxMemory, {
                type: 'line',
                data: {
                    labels: memoryTimestamps,
                    datasets: [{
                        label: 'Uso de Memoria (RSS)',
                        data: memoryValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        fill: false,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        async function init() {
            const latenciaData = await fetchLatencia();
            drawLatenciaChart(latenciaData);

            const cpuMemoryData = await fetchCpuMemory();

            // Separar los datos de CPU y memoria
            const cpuData = cpuMemoryData.map(entry => ({
                timestamp: entry.timestamp,
                cpu: entry.cpu
            }));

            const memoryData = cpuMemoryData.map(entry => ({
                timestamp: entry.timestamp,
                memory: entry.memory.rss
            }));

            drawCpuMemoryChart(cpuData, memoryData);
        }

        init();
    </script>
</body>
</html>
